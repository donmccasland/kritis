# Cloudbuild pipeline for a build with an image
# that passes the vuln policy
steps:
  # Build a 'good' image
  - name: gcr.io/cloud-builders/docker
    entrypoint: /bin/bash
    args:
      - -c
      - |
        docker build -t gcr.io/$PROJECT_ID/binauthz-test:latest -f ./Dockerfile.good .
    id: build
  - name: gcr.io/cloud-builders/docker
    entrypoint: /bin/bash
    args:
    - -c
    - |
      docker tag gcr.io/$PROJECT_ID/binauthz-test:latest gcr.io/$PROJECT_ID/binauthz-test:good &&
      docker push gcr.io/$PROJECT_ID/binauthz-test:latest &&
      docker push gcr.io/$PROJECT_ID/binauthz-test:good &&
      docker image inspect gcr.io/$PROJECT_ID/binauthz-test:latest --format '{{index .RepoDigests 0}}' > image-digest.txt &&
      cat image-digest.txt
    id: push
  - name: gcr.io/$PROJECT_ID/kritis-signer
    entrypoint: /bin/bash
    args:
    - -c
    - |
      /kritis/signer \
      -mode=check-and-sign \
      -v=10 \
      -alsologtostderr \
      -image=$(/bin/cat image-digest.txt) \
      -policy=policy.yaml \
      -overwrite=true \
      -note_name=projects/global-grammar-291814/notes/vuln-check-passed-note \
      -attestation_project=global-grammar-291814 \
      -kms_key_name=projects/global-grammar-291814/locations/global/keyRings/attestors/cryptoKeys/vuln-check-signing-key/cryptoKeyVersions/1 \
      -kms_digest_alg=SHA256
    waitFor: push
    id: vulnsign
images: ['gcr.io/$PROJECT_ID/binauthz-test:latest']

